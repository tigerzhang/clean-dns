# Tasks

- [ ] Explore codebase to identify hook points for statistics <!-- id: 0 -->
- [ ] Create implementation plan <!-- id: 1 -->
- [x] Implement data structure for statistics <!-- id: 2 -->
- [x] Implement statistics gathering logic <!-- id: 3 -->
  - [x] Domain names <!-- id: 4 -->
        x [x] IP addresses resolved <!-- id: 5 -->
  - [x] Resolve request count <!-- id: 6 -->
  - [x] Cache hit count <!-- id: 7 -->
  - [x] Latest resolve timestamp <!-- id: 8 -->
- [x] Implement API Endpoint <!-- id: 10 -->
  - [x] Add dependencies (axum, serde) <!-- id: 11 -->
  - [x] Create [src/api.rs](file:///Users/zhanghu/vpn/clean-dns/src/api.rs) <!-- id: 12 -->
  - [x] Update [src/config.rs](file:///Users/zhanghu/vpn/clean-dns/src/config.rs) <!-- id: 13 -->
  - [x] Update [src/main.rs](file:///Users/zhanghu/vpn/clean-dns/src/main.rs) to spawn API server <!-- id: 14 -->
- [x] Verify implementation <!-- id: 9 -->

- [ ] Add Tests <!-- id: 15 -->
  - [ ] Create implementation plan for tests <!-- id: 16 -->
    - [x] Unit Tests: [src/statistics.rs](file:///Users/zhanghu/vpn/clean-dns/src/statistics.rs) <!-- id: 17 -->
      - [x] Test [record_request](file:///Users/zhanghu/vpn/clean-dns/src/statistics.rs#24-34) inserts/updates correctly <!-- id: 18 -->
      - [x] Test [record_resolved_ip](file:///Users/zhanghu/vpn/clean-dns/src/statistics.rs#56-61) keeps unique IPs <!-- id: 19 -->
      - [x] Test [record_cache_hit](file:///Users/zhanghu/vpn/clean-dns/src/statistics.rs#35-55) increments correctly <!-- id: 20 -->
    - [x] Unit Tests: Plugins <!-- id: 26 -->
      - [x] Matcher Plugin <!-- id: 27 -->
      - [x] Cache Plugin <!-- id: 28 -->
      - [x] Forward, Sequence, If, IP/Domain Set, Hosts, Reject, Return, Delay, Fallback, TTL <!-- id: 29 -->
    - [x] Integration Tests: [tests/integration.rs](file:///Users/zhanghu/vpn/clean-dns/tests/integration.rs) <!-- id: 21 -->
      - [x] Setup test server environment <!-- id: 22 -->
      - [x] Test API endpoint returns valid JSON <!-- id: 23 -->
      - [x] Test DNS query updates stats <!-- id: 24 -->
  - [x] Run `cargo test` and ensure all pass <!-- id: 25 -->
