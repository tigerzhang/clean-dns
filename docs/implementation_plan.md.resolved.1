# MosDNS Clone in Rust (CleanDNS) Implementation Plan

This plan outlines the steps to build `clean-dns`, a modular DNS forwarder inspired by `mosdns`, written in Rust.

## User Review Required

> [!IMPORTANT]
> This implementation uses `hickory-dns` (formerly `trust-dns`) for low-level DNS protocol handling.
> The architecture will be purely plugin-driven, similar to `mosdns`.

## Proposed Changes

We will create a new Rust project with the following structure:

```text
clean-dns/
├── Cargo.toml
├── src/
│   ├── main.rs           # Entry point
│   ├── config.rs         # Configuration loading
│   ├── server.rs         # DNS Server implementation
│   └── plugins/          # Plugin system
│       ├── mod.rs        # Plugin trait definition
│       ├── sequence.rs   # Chain of responsibility
│       ├── forward.rs    # Updater/Forwarder
│       └── matcher.rs    # Domain/IP matching
```

### Core Components

#### [NEW] [Cargo.toml](file:///Users/zhanghu/vpn/clean-dns/Cargo.toml)

- Dependencies: `tokio`, `hickory-server`, `hickory-proto`, `serde`, `serde_yaml`, `anyhow`, `tracing`, `tracing-subscriber`.

#### [NEW] [src/plugins/mod.rs](file:///Users/zhanghu/vpn/clean-dns/src/plugins/mod.rs)

- Defines the [Plugin](file:///Users/zhanghu/vpn/clean-dns/src/plugins/mod.rs#30-38) trait.
- Defines the [Context](file:///Users/zhanghu/vpn/clean-dns/src/plugins/mod.rs#12-17) struct (holds the query, response, and client info).

#### [NEW] [src/server.rs](file:///Users/zhanghu/vpn/clean-dns/src/server.rs)

- Implements a UDP/TCP listener using `hickory-dns`'s server components or custom `tokio` sockets if more control is needed (MosDNS often uses raw sockets for flexibility, but we'll start with `hickory-server`'s `RequestHandler` trait for simplicity).

#### [NEW] [src/plugins/matcher.rs](file:///Users/zhanghu/vpn/clean-dns/src/plugins/matcher.rs)
- Implements domain matching (suffix/exact).
- Can match against a list of domains.
- If matched, executes a "then" sub-plugin? Or simply returns "true" for a boolean check? 
  - *Design decision*: MosDNS matchers often act as routers. If matched, run sub-sequence.

#### [NEW] [src/plugins/cache.rs](file:///Users/zhanghu/vpn/clean-dns/src/plugins/cache.rs)
- Implements an enhanced LRU cache for DNS responses.
- Respects TTL.

#### [NEW] [src/plugins/fallback.rs](file:///Users/zhanghu/vpn/clean-dns/src/plugins/fallback.rs)
- Takes a primary and secondary plugin.
- Runs primary; if it fails (network error), runs secondary.

#### [Modifying] [src/config.rs](file:///Users/zhanghu/vpn/clean-dns/src/config.rs)
- Refactor to support dynamic plugin definitions (e.g., `type: sequence`, `args: ...`).

### Verification Plan

#### Automated Tests

- Unit tests for each plugin (e.g., verifying `Matcher` correctly matches domains).
- Integration test: Start the server and send a DNS query using `dig` to verify forwarding works.

#### Manual Verification

- Run `cargo run -- -c config.yaml`.
- Use `dig @127.0.0.1 -p 5335 google.com` to test resolution.
