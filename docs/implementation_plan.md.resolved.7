# Forward Plugin Refactor Plan

We will refactor the `forward` plugin to match MosDNS's capabilities, specifically supporting multiple upstreams, concurrent querying ("race" strategy), and SOCKS5 proxy support.

## Proposed Changes

### [MODIFY] [Cargo.toml](file:///Users/zhanghu/vpn/clean-dns/Cargo.toml)
- Add `tokio-socks = "0.5"` (or latest compatible).
- Add `rand = "0.8"`. 

### [MODIFY] [src/plugins/forward.rs](file:///Users/zhanghu/vpn/clean-dns/src/plugins/forward.rs)
- Update [ForwardConfig](file:///Users/zhanghu/vpn/clean-dns/src/plugins/forward.rs#12-15):
    - `upstreams`: `Vec<String>` (replaces `addr`).
    - `concurrent`: `u32` (default 1).
    - `socks5`: `Option<String>` (e.g., "127.0.0.1:1080").
- Update [Forward](file:///Users/zhanghu/vpn/clean-dns/src/plugins/forward.rs#16-19) struct:
    - Store `upstreams` as `Vec<SocketAddr>`.
    - Store `concurrent`.
    - Store `socks5_addr` as `Option<SocketAddr>`.
- Logic Update:
    - If `socks5` is configured:
        - Use `tokio_socks::tcp::Socks5Stream` or `UdpAssociate`?
        - DNS is UDP. SOCKS5 supports UDP ASSOCIATE.
        - Implementation details: Connect to SOCKS5 server, Request UDP Associate, Send UDP packets via the relay.
    - If `concurrent > 1`:
        - Pick random upstreams.
        - Race them (with or without proxy).

## Verification
- Add `rand` and `tokio-socks` dependencies.
- Configure `forward` with `socks5: "127.0.0.1:1080"` (Need a running proxy to verify).
- Dry-run verification if no proxy available (or mock).
