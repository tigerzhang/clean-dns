# Add Unit and Integration Tests

## Goal
Add comprehensive testing to ensure reliability of statistics and server functionality.

## Proposed Changes

### [REFAC] Refactor to Library Structure
To support `tests/` integration tests, we need to expose modules via `lib.rs`.

#### [NEW] [src/lib.rs](file:///Users/zhanghu/vpn/clean-dns/src/lib.rs)
- Expose modules: [api](file:///Users/zhanghu/vpn/clean-dns/src/api.rs#9-20), `config`, `plugins`, [server](file:///Users/zhanghu/vpn/clean-dns/src/api.rs#9-20), `statistics`.
- Re-export necessary types.

#### [MODIFY] [src/main.rs](file:///Users/zhanghu/vpn/clean-dns/src/main.rs)
- Reduce to a thin wrapper that calls `clean_dns::...`.
- Use `clean_dns::config::Config`, `clean_dns::server::Server`, etc.

### [NEW] Unit Tests
#### [MODIFY] [src/statistics.rs](file:///Users/zhanghu/vpn/clean-dns/src/statistics.rs)
- Add `#[cfg(test)] mod tests { ... }`.
- Test [record_request](file:///Users/zhanghu/vpn/clean-dns/src/statistics.rs#24-34): verify count and timestamp update.
- Test [record_resolved_ip](file:///Users/zhanghu/vpn/clean-dns/src/statistics.rs#56-61): verify IP set growth and uniqueness.
- Test [record_cache_hit](file:///Users/zhanghu/vpn/clean-dns/src/statistics.rs#35-55): verify count increment.

### [NEW] Integration Tests
#### [NEW] [tests/integration.rs](file:///Users/zhanghu/vpn/clean-dns/tests/integration.rs)
- Test suite using `tokio::test`.
- Helper to start server on random/test ports.
- Test 1: **API Stats**:
    - Start server.
    - Call `GET /stats`.
    - Assert empty/initial stats.
- Test 2: **DNS Query + Stats**:
    - Start server.
    - Send DNS query (using `hickory-client` or raw socket).
    - Assert response is valid.
    - Call `GET /stats`.
    - Assert stats reflect the query (count=1, domain correct).

### [MODIFY] [Cargo.toml](file:///Users/zhanghu/vpn/clean-dns/Cargo.toml)
- Add `reqwest` to dev-dependencies (blocking or async, needed for API test).
- Add `tokio` with `test-util` feature? It has `full`.

## Verification Plan

### Automated Tests
- Run `cargo test`.
- Verify all unit and integration tests pass.
